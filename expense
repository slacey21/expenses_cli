#!/usr/bin/env node

const { Client } = require('pg');
const { argv } = require('node:process');
const client = new Client({
  database: 'expenses_cli'
});

const HELP = `
An expense recording system

Commands:

add AMOUNT MEMO [DATE] - record a new expense
clear - delete all expenses
list - list all expenses
delete NUMBER - remove expense with id NUMBER
search QUERY - list expenses with a matching memo field`;


function displayHelp() {
  console.log(HELP);
}

async function listExpenses() {
  await client.connect();
  
  let response = await client.query('SELECT * FROM expenses ORDER BY created_on');

  response.rows.forEach(tuple => {
    let columns = [
      `${tuple.id}`.padStart(3),
      tuple.created_on.toDateString().padStart(10),
      tuple.amount.padStart(12),
      tuple.memo
    ];
    
    console.log(columns.join(' | '))

  });
  
  client.end()
};

async function addExpense(amount, memo) {
  await client.connect();
  
  let date = new Date().toLocaleDateString();
  
  await client.query(`INSERT INTO expenses (created_on, amount, memo)
  VALUES ('${date}', ${amount}, '${memo}')
  `);
  
  client.end()
}

let command = argv[2];

if (command === 'help') {
  displayHelp();
} else if (command === 'list') {
    listExpenses();
} else if (command === 'add') {
  let amount = argv[3];
  let memo = argv[4];
  
  if (amount && memo) {
    addExpense(amount, memo);
  } else {
    console.log('You must provide an amount and memo.');
  }
} 